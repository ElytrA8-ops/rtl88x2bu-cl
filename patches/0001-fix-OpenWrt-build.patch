From: Miroslav Dimitrov <mirobiala@gmail.com>
Date: Mon Sep 18 10:15:35 EEST 2023
Subject: [PATCH 1/3] OpenWrt build patch

---
 Makefile                      | 32 ++++++++++++++++++++++++++++++--
 include/byteorder/swab.h      |  2 +-
 os_dep/linux/ioctl_cfg80211.c |  2 +-
 3 files changed, 32 insertions(+), 4 deletions(-)

diff --git a/Makefile b/Makefile
index e98e3ca..128de80 100644
--- a/Makefile
+++ b/Makefile
@@ -101,7 +101,7 @@ EXTRA_CFLAGS += -DCONFIG_RTW_ANDROID=$(CONFIG_RTW_ANDROID)
 endif

 ########################## Debug ###########################
-CONFIG_RTW_DEBUG = y
+CONFIG_RTW_DEBUG = n
 # default log level is _DRV_INFO_ = 4,
 # please refer to "How_to_set_driver_debug_log_level.doc" to set the available level.
 CONFIG_RTW_LOG_LEVEL = 3
@@ -137,7 +137,8 @@ CONFIG_LAYER2_ROAMING = y
 #bit0: ROAM_ON_EXPIRED, #bit1: ROAM_ON_RESUME, #bit2: ROAM_ACTIVE
 CONFIG_ROAMING_FLAG = 0x3
 ###################### Platform Related #######################
-CONFIG_PLATFORM_I386_PC = y
+CONFIG_PLATFORM_OPENWRT = y
+CONFIG_PLATFORM_I386_PC = n
 CONFIG_PLATFORM_ANDROID_X86 = n
 CONFIG_PLATFORM_ANDROID_INTEL_X86 = n
 CONFIG_PLATFORM_JB_X86 = n
@@ -1336,6 +1337,33 @@ ifeq ($(CONFIG_RTW_IOCTL_SET_COUNTRY), y)
 EXTRA_CFLAGS += -DCONFIG_RTW_IOCTL_SET_COUNTRY
 endif
 
+ifeq ($(CONFIG_PLATFORM_OPENWRT), y)
+include $(TOPDIR)/rules.mk
+include $(INCLUDE_DIR)/kernel.mk
+
+EXTRA_CFLAGS += -DCONFIG_MINIMAL_MEMORY_USAGE \
+		-DCONFIG_LITTLE_ENDIAN \
+		-DCONFIG_IOCTL_CFG80211 \
+		-DRTW_USE_CFG80211_STA_EVENT \
+		-DCONFIG_RTW_CHPLAN=0x76 \
+		-DCONFIG_TDLS \
+		-DCONFIG_RTW_MESH \
+		-DCONFIG_RTW_MULTI_AP \
+		-DCONFIG_CALIBRATE_TX_POWER_TO_MAX \
+		-DCONFIG_P2P \
+		-DCONFIG_FORCE_SW_CHANNEL_PLAN \
+		-DCONFIG_CONCURRENT_MODE \
+		-DCONFIG_IFACE_NUMBER=4 \
+		-DCONFIG_QOS_OPTIMIZATION \
+		-Wno-error
+
+USER_MODULE_NAME := rtl$(MODULE_NAME)
+ARCH="$(LINUX_KARCH)"
+CROSS_COMPILE="$(TARGET_CROSS)"
+KSRC="$(LINUX_DIR)"
+KVER="$(LINUX_VERSION)"
+endif
+
 ifeq ($(CONFIG_PLATFORM_I386_PC), y)
 EXTRA_CFLAGS += -DCONFIG_LITTLE_ENDIAN
 EXTRA_CFLAGS += -DCONFIG_IOCTL_CFG80211 -DRTW_USE_CFG80211_STA_EVENT
diff --git a/include/byteorder/swab.h b/include/byteorder/swab.h
index a8dd46b..64f1f3d 100644
--- a/include/byteorder/swab.h
+++ b/include/byteorder/swab.h
@@ -12,7 +12,7 @@
  * more details.
  *
  *****************************************************************************/
-#ifndef _LINUX_BYTEORDER_SWAB_H
+#if !defined(_UAPI_LINUX_SWAB_H) && !defined(_LINUX_BYTEORDER_SWAB_H)
 #define _LINUX_BYTEORDER_SWAB_H

 #if !defined(CONFIG_PLATFORM_MSTAR)
diff --git a/os_dep/linux/ioctl_cfg80211.c b/os_dep/linux/ioctl_cfg80211.c
index f7b59a8..ac1e0b2 100644
--- a/os_dep/linux/ioctl_cfg80211.c
+++ b/os_dep/linux/ioctl_cfg80211.c
@@ -459,7 +459,7 @@
 		cfg80211_ch_switch_started_notify(adapter->pnetdev, &chdef, 0, 0, false, 0);
 #elif (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 1, 0))
 		cfg80211_ch_switch_started_notify(adapter->pnetdev, &chdef, 0, 0, false);
-#elif (LINUX_VERSION_CODE >= KERNEL_VERSION(5, 11, 0))
+#elif ((LINUX_VERSION_CODE >= KERNEL_VERSION(5, 11, 0)) || defined(BUILD_OPENWRT))

 		/* --- cfg80211_ch_switch_started_notfiy() ---
 		 *  A new parameter, bool quiet, is added from Linux kernel v5.11,
-- 
1.0.0
